
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Experiments Using The SAFE Protocol &#8212; MSc Computing Individual Project</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SAFE Protocol NLP Experiments" href="safe-nlp-experiments.html" />
    <link rel="prev" title="OpenMined’s PyDP Tutorial" href="../dp-experiment/openmined-dp-experiments.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">MSc Computing Individual Project</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    ICL MSc Computing Individual Project
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../dp-experiment/openmined-dp-experiments.html">
   OpenMined’s PyDP Tutorial
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Experiments Using The SAFE Protocol
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="safe-nlp-experiments.html">
   SAFE Protocol NLP Experiments
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/jjquek/indiv-project-exps/master?urlpath=tree/safe-experiments/safe-experiments.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/jjquek/indiv-project-exps"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/jjquek/indiv-project-exps/issues/new?title=Issue%20on%20page%20%2Fsafe-experiments/safe-experiments.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/safe-experiments/safe-experiments.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-toy-implementation">
   Setting Up Toy Implementation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-raw-vector-creation">
     Set Up Raw Vector Creation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#share-creation-and-distribution">
   SHARE CREATION AND DISTRIBUTION
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#obfuscated-vector-generation">
   Obfuscated Vector Generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aggregating-feature-vectors">
   Aggregating Feature Vectors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#utility-of-protocol">
   Utility of Protocol
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluating-safe-s-robustness">
   Evaluating SAFE’s Robustness
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adversarial-aggregator">
     Adversarial Aggregator
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-protocol-more-secure">
   Making Protocol More Secure
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Experiments Using The SAFE Protocol</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-toy-implementation">
   Setting Up Toy Implementation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-raw-vector-creation">
     Set Up Raw Vector Creation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#share-creation-and-distribution">
   SHARE CREATION AND DISTRIBUTION
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#obfuscated-vector-generation">
   Obfuscated Vector Generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aggregating-feature-vectors">
   Aggregating Feature Vectors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#utility-of-protocol">
   Utility of Protocol
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluating-safe-s-robustness">
   Evaluating SAFE’s Robustness
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adversarial-aggregator">
     Adversarial Aggregator
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-protocol-more-secure">
   Making Protocol More Secure
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="experiments-using-the-safe-protocol">
<h1>Experiments Using The SAFE Protocol<a class="headerlink" href="#experiments-using-the-safe-protocol" title="Permalink to this headline">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>This notebook includes the experiments conducted using the SAFE Protocol. The goal was to assess the suitability of the SAFE Protocol for meeting the privacy and utility constraints outlined in the introduction of the report, as well as consider possible extensions.</p>
<p>The notebook has the following contents:</p>
<ul class="simple">
<li><p>Toy Implementation Of SAFE (How SAFE works)</p></li>
<li><p>Evaluation of SAFE’s Robustness</p></li>
<li><p>Making SAFE more robust.</p></li>
</ul>
<p>The Toy implementation of SAFE is merely illustrative– mock data of a small size will be used to illustrate the basic mechanics of the SAFE protocol.</p>
</section>
<section id="setting-up-toy-implementation">
<h2>Setting Up Toy Implementation<a class="headerlink" href="#setting-up-toy-implementation" title="Permalink to this headline">#</a></h2>
<p>To illustrate how the SAFE Protocol works, we will mock the data of 5 users who contribute feature vectors.</p>
<section id="set-up-raw-vector-creation">
<h3>Set Up Raw Vector Creation<a class="headerlink" href="#set-up-raw-vector-creation" title="Permalink to this headline">#</a></h3>
<p>First, let’s create the raw feature vectors for each user. These vectors represent the raw data the SAFE protocol wants to keep private whilst allowing for useful computation over.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SET UP - Create raw feature vectors </span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="c1"># for reproducibility</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># CONSTANTS for a run of the Protocol</span>
<span class="n">NUMBER_OF_USERS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">NUMBER_OF_FEATURES_PER_USER_VECTOR</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">VECTOR_SHAPE</span> <span class="o">=</span> <span class="p">(</span><span class="n">NUMBER_OF_FEATURES_PER_USER_VECTOR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># TODO: actually, VECTOR_SHAPE is redundant. That wasn&#39;t the source of the error. But, anyways.</span>
 
<span class="n">raw_feature_vectors</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="n">raw_feature_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">VECTOR_SHAPE</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Here are is the feature vector for user </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">raw_feature_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># SET UP - Create raw feature vectors </span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="c1"># for reproducibility</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torch&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="share-creation-and-distribution">
<h2>SHARE CREATION AND DISTRIBUTION<a class="headerlink" href="#share-creation-and-distribution" title="Permalink to this headline">#</a></h2>
<p>Next, each user will generate (N-1) shares from the interval [-D, D], where N is the number of users.</p>
<p>Each share is a K-dimensional vector, where K is the number of features each user’s raw feature vector has.</p>
<p>Each user uses these N-1 shares to generate their own Nth share.</p>
<p>Then, they will distribute the N-1 shares to the other N-1 users, whilst keeping their Nth share.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SHARE CREATION</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">token</span> <span class="kn">import</span> <span class="n">NUMBER</span>
<span class="kn">from</span> <span class="nn">unicodedata</span> <span class="kn">import</span> <span class="n">name</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">shares_memory</span> 
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">D_VALUE</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c1"># defining the interval from which users drawn random share vectors.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating the shares for each user </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">each_users_shares_to_distribute</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># mapping from i to list of tensors.</span>
<span class="n">each_users_Nth_share</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># mapping from i to 4-D tensor</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="c1"># Each user first generates N-1 shares : a share to be sent to every other user.</span>
    <span class="n">each_users_shares_to_distribute</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">other_user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">share_to_distribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">D_VALUE</span><span class="p">,</span> <span class="n">D_VALUE</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_FEATURES_PER_USER_VECTOR</span><span class="p">)]</span>
        <span class="n">share_to_distribute</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">share_to_distribute</span><span class="p">),</span> <span class="n">VECTOR_SHAPE</span><span class="p">)</span>
        <span class="n">each_users_shares_to_distribute</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">share_to_distribute</span><span class="p">)</span>
    <span class="c1"># Then, each user calculates their own Nth share from the N-1 Shares the draw from the interval</span>
    <span class="n">sum_of_shares</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">VECTOR_SHAPE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">each_users_shares_to_distribute</span><span class="p">[</span><span class="n">user</span><span class="p">]:</span>
        <span class="n">sum_of_shares</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">share</span><span class="p">)</span>
    <span class="c1"># print(f&quot;Here is user_{user}&#39;s sum of shares: {sum_of_shares}&quot;)</span>
    <span class="n">each_users_Nth_share</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_feature_vectors</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">-</span> <span class="n">sum_of_shares</span> 
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TODO:</span>
<span class="sd">Not sure whether there&#39;s a better way to generate the shares. The calls to the random.uniform() method for each share vector value seems sub-optimal but I can&#39;t quite find an &#39;off-the-shelf&#39; method that generates the matrix/dictionary more easily. This triple nested loop is not computationally efficient. Is commenting on the algorithm&#39;s time complexity worth doing?</span>

<span class="sd">TODO: </span>
<span class="sd">Also not sure whether the &#39;random&#39; provided by Python is sufficiently random. Or whether the presence of a &#39;seed&#39; value complicates things.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Let&#39;s take a look at shares each user will distribute:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">each_users_shares_to_distribute</span><span class="p">[</span><span class="n">user</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">share</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;And here&#39;s their Nth share:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">each_users_Nth_share</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generating the shares for each user 

Let&#39;s take a look at shares each user will distribute:

User 0: 

tensor([[6.8884],
        [5.1591]])
tensor([[-1.5886],
        [-4.8217]])


And here&#39;s their Nth share:

tensor([[-4.8036],
        [ 0.4308]])


User 1: 

tensor([[ 0.2255],
        [-1.9013]])
tensor([[ 5.6760],
        [-3.9337]])


And here&#39;s their Nth share:

tensor([[-5.8130],
        [ 5.9671]])


User 2: 

tensor([[-0.4681],
        [ 1.6676]])
tensor([[8.1623],
        [0.0937]])


And here&#39;s their Nth share:

tensor([[-7.3868],
        [-1.1273]])
</pre></div>
</div>
</div>
</div>
<p>Now, let’s distribute the shares among the users.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SHARE Distribution</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing shares...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">each_users_received_shares</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># set up the map</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="n">each_users_received_shares</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># fill the map</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="n">other_user_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">)</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">!=</span> <span class="n">user</span><span class="p">]</span>
    <span class="c1"># get the shares for user_0 to send to other users</span>
    <span class="n">shares_to_send</span> <span class="o">=</span> <span class="p">[</span><span class="n">share</span> <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">each_users_shares_to_distribute</span><span class="p">[</span><span class="n">user</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">other_user</span><span class="p">,</span> <span class="n">share_to_send</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">other_user_ids</span><span class="p">,</span> <span class="n">shares_to_send</span><span class="p">):</span>
        <span class="n">each_users_received_shares</span><span class="p">[</span><span class="n">other_user</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">share_to_send</span><span class="p">)</span>
<span class="c1"># TODO - add a more robust sanity check to ensure shares were sent.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Let&#39;s see what the first three users got:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> received:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">each_users_received_shares</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># sanity check</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">each_users_received_shares</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">NUMBER_OF_USERS</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distributing shares...

Let&#39;s see what the first three users got:
User_0 received:
tensor([[ 0.2255],
        [-1.9013]])
tensor([[-0.4681],
        [ 1.6676]])


User_1 received:
tensor([[6.8884],
        [5.1591]])
tensor([[8.1623],
        [0.0937]])


User_2 received:
tensor([[-1.5886],
        [-4.8217]])
tensor([[ 5.6760],
        [-3.9337]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="obfuscated-vector-generation">
<h2>Obfuscated Vector Generation<a class="headerlink" href="#obfuscated-vector-generation" title="Permalink to this headline">#</a></h2>
<p>Each user can now calculate their own ofuscated feature vector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">GENERATING OBFUSCATED FEATURE Vectors:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">each_users_masked_vector</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="n">sum_of_received_shares</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">VECTOR_SHAPE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">each_users_received_shares</span><span class="p">[</span><span class="n">user</span><span class="p">]:</span>
        <span class="n">sum_of_received_shares</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">share</span><span class="p">)</span>
    <span class="n">each_users_masked_vector</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">each_users_Nth_share</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+</span> <span class="n">sum_of_received_shares</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Here&#39;s what each user will send to the aggregator:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">masked_vector</span> <span class="ow">in</span> <span class="n">each_users_masked_vector</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">masked_vector</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Here&#39;s what each user will send to the aggregator:

User 0:
tensor([[-5.0462],
        [ 0.1971]])


User 1:
tensor([[ 9.2377],
        [11.2199]])


User 2:
tensor([[-3.2994],
        [-9.8827]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="aggregating-feature-vectors">
<h2>Aggregating Feature Vectors<a class="headerlink" href="#aggregating-feature-vectors" title="Permalink to this headline">#</a></h2>
<p>Now we will mock an aggregator who receives each feature vector and computes a target function. In the actual protocol, each user would ‘send’ their masked vector to an aggregator. For simplicity’s sake, we will simply act as an aggregator that has already received these vectors, and simply compute the target function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computing Target Function: Aggregate Sum</span>

<span class="n">target_result</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">raw_feature_vectors</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">raw_feature_vectors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">masked_vector_result</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">each_users_masked_vector</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">each_users_masked_vector</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of masked vectors: </span><span class="se">\n\n</span><span class="s2"> </span><span class="si">{</span><span class="n">masked_vector_result</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of raw vectors: </span><span class="se">\n\n</span><span class="s2"> </span><span class="si">{</span><span class="n">target_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sum of masked vectors: 

 tensor([[0.8922],
        [1.5343]])

Sum of raw vectors: 

 tensor([[0.8922],
        [1.5343]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="utility-of-protocol">
<h2>Utility of Protocol<a class="headerlink" href="#utility-of-protocol" title="Permalink to this headline">#</a></h2>
<p>As the output from the code block above shows, the aggregate sum of the masked vectors is equivalent to the aggregate sum of the raw vectors of the users.</p>
<p>Also, it follows from this that simple mean of both vector sets are equal as well.</p>
<p>SAFE thus does allow one to compute some aggregate functions over user data without having direct access to the user data.</p>
<p>However, let us now consider how robustly it masks the raw feature vectors from potential adversaries who would try to infer things about the raw data from it.</p>
</section>
<section id="evaluating-safe-s-robustness">
<h2>Evaluating SAFE’s Robustness<a class="headerlink" href="#evaluating-safe-s-robustness" title="Permalink to this headline">#</a></h2>
<p>We will consider this in terms of the information flow that the protocol allows from, and from the perspective of an adversarial aggregator, and an adversarial set of user(s).</p>
<section id="adversarial-aggregator">
<h3>Adversarial Aggregator<a class="headerlink" href="#adversarial-aggregator" title="Permalink to this headline">#</a></h3>
<p>We will assume that the aggregator knows what is presented plainly in Huth and Chuartwal’s paper i.e., the equations listed in Section 4. Moreover, as described in the Protocol, the aggregator receives from each user an obfuscated feature vector. Finally, let us assume that the aggregator knows the values of the interval [-D, D] from which the users compute their share vectors.</p>
<p>We want to ascertain what such an aggregator could infer from what they know.</p>
<!--Let us consider an even simpler example than the one we ran above: each user's raw feature vector is just one dimension.

Let `x` represent the `user_x`'s raw vector. Recall that, the value of a user's feature vectors are within the interval `[0,1]`, representing probabilities. So, let the value in `x` = 0.3. 

The aggregator knows the interval the users draws from is, as in our toy run,  `[-10, 10]`. 

Now, suppose the aggregator draws a random share from this interval, `y` , and `y` = -5.7.

Additionally, the aggregator receives an obfuscated vector `x'` from `user_x` , and `x'` = -5.4.-->
<p>Suppose the adversarial aggregator drew their own N-1 shares from the same <code class="docutils literal notranslate"><span class="pre">[-D,</span> <span class="pre">D]</span></code> distribution. They could try to make an educated guess about the distribution of the raw feature values through reverse engineering:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregator samples (N-1) Random shares for each user.</span>

<span class="n">aggregators_random_shares_per_user</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="n">aggregators_random_shares_per_user</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">share</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">D_VALUE</span><span class="p">,</span> <span class="n">D_VALUE</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_FEATURES_PER_USER_VECTOR</span><span class="p">)]</span>
        <span class="n">share</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">share_to_distribute</span><span class="p">),</span> <span class="n">VECTOR_SHAPE</span><span class="p">)</span>
        <span class="n">aggregators_random_shares_per_user</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">share</span><span class="p">)</span>

<span class="n">received_masked_vectors</span> <span class="o">=</span> <span class="n">each_users_masked_vector</span>

<span class="c1"># Minus the Sum of the N-1 Shares From The Masked Vectors To Approximate Nth Share</span>

<span class="n">approximation_of_each_users_Nth_share</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_USERS</span><span class="p">):</span>
    <span class="n">sum_of_aggregators_random_shares</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">VECTOR_SHAPE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aggregators_random_shares_per_user</span><span class="p">[</span><span class="n">user</span><span class="p">]:</span>
        <span class="n">sum_of_aggregators_random_shares</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">approximation_of_each_users_Nth_share</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span>  <span class="n">received_masked_vectors</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">-</span> <span class="n">sum_of_aggregators_random_shares</span>

<span class="nb">print</span><span class="p">(</span><span class="n">approximation_of_each_users_Nth_share</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> 

<span class="c1"># Minus the Sum of the N-1 Shares Again From Approximation : TODO why?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_items([(0, tensor([[-0.3114],
        [-9.7826]])), (1, tensor([[13.9725],
        [ 1.2402]])), (2, tensor([[  1.4354],
        [-19.8625]]))])
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_38923/2521218717.py:8: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  share = torch.reshape(torch.tensor(share_to_distribute), VECTOR_SHAPE)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="making-protocol-more-secure">
<h2>Making Protocol More Secure<a class="headerlink" href="#making-protocol-more-secure" title="Permalink to this headline">#</a></h2>
<p>Here, we illustrate the use of Homomorphic Encryption to make the protocol even more secure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Adjusting Feature Value Representation</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\nAdjusting Feature Value Representation\n&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "my_venv"
        },
        kernelOptions: {
            kernelName: "my_venv",
            path: "./safe-experiments"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'my_venv'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../dp-experiment/openmined-dp-experiments.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">OpenMined’s PyDP Tutorial</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="safe-nlp-experiments.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">SAFE Protocol NLP Experiments</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Barry Quek Jing Jet<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>